<div class="kt-world-map-wrapper">
    <div class="kt-map-svg-layer">
        {% comment %} é€™è£¡å¼•å…¥æ‚¨åŸæœ¬çš„ icon-world-map.liquid {% endcomment %}
        {% render 'icon-world-map' %}
    </div>

    <div class="kt-landmarks-layer">
        {% for block in section.blocks %}
            {% assign tooltip_class = '' %}
            {% assign pos_y = block.settings.pos_y | plus: 0 %}
            {% if pos_y < 45 %}
                {% assign tooltip_class = 'kt-tooltip-bottom' %}
            {% endif %}
            <div
                class="kt-hotspot {{ tooltip_class }}"
                style="top: {{ block.settings.pos_y }}%; left: {{ block.settings.pos_x }}%;"
                tabindex="0"
                {{ block.shopify_attributes }}
            >
                <div class="kt-pin-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#E31D1A"/>
                        <circle cx="12" cy="9" r="2.5" fill="white"/>
                    </svg>
                    <div class="kt-pin-pulse"></div>
                </div>

                <div class="kt-artisan-card">
                    <div class="kt-card-inner">
                        <div class="kt-card-image">
                            {% if block.settings.image != blank %}
                                {{
                                    block.settings.image
                                    | image_url: width: 240
                                    | image_tag: loading: 'lazy', alt: block.settings.name
                                }}
                            {% else %}
                                <img src="https://placehold.co/80x80/png?text=PIC" alt="Artisan">
                            {% endif %}
                        </div>
                        <div class="kt-card-info">
                            {% if block.settings.country != blank %}
                                <div class="kt-artisan-country">{{ block.settings.country }}</div>
                            {% endif %}
                            <h4 class="kt-artisan-name">{{ block.settings.name }}</h4>
                            <p class="kt-artisan-desc">{{ block.settings.description }}</p>
                            <a href="{{ block.settings.link | default: '#' }}" class="kt-more-btn">MORE</a>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<style>
    /* å®¹å™¨è¨­å®šï¼šç¢ºä¿åœ°æ¨™å±¤èˆ‡åœ°åœ–å±¤å®Œç¾é‡ç–Š */
    .kt-world-map-wrapper {
        position: relative;
        width: 100%;
        max-width: 1440px; /* ä¾æ“šæ‚¨çš„ç‰ˆé¢èª¿æ•´ */
        margin: 0 auto;
        padding: 40px 20px; /* ä¸Šä¸‹ç•™ç™½ï¼Œé¿å…å°å¡è¢«åˆ‡åˆ° */
        {% comment %} background-color: #f4f4f4; /* ç¤ºæ„èƒŒæ™¯è‰² */ {% endcomment %}
        overflow: visible; /* å…è¨±å°å¡è¶…å‡ºé‚Šç•Œ */
    }

    /* 1. åœ°åœ–å±¤ï¼šè®“ SVG è‡ªé©æ‡‰å¯¬åº¦ */
    .kt-map-svg-layer svg {
        width: 100%;
        height: auto;
        display: block;
        fill: #d1d1d1; /* é è¨­åœ°åœ–é¡è‰² */
    }

    /* 2. åœ°æ¨™å±¤ï¼šè¦†è“‹åœ¨ä¸Šæ–¹ */
    .kt-landmarks-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°åœ°åœ–ï¼Œé™¤éé»åˆ°åœ°æ¨™ */
    }

    /* ç†±é»å®¹å™¨ */
    .kt-hotspot {
        position: absolute;
        transform: translate(-50%, -100%); /* è®“å®šä½é»å°æº– Icon åº•éƒ¨å°–ç«¯ */
        pointer-events: auto; /* æ¢å¾©äº’å‹• */
        cursor: pointer;
        {% comment %} z-index: 10; {% endcomment %}
    }

    /* A. ç´…è‰²åœ°æ¨™æ¨£å¼ */
    .kt-pin-icon {
        position: relative;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
       
    }

    /* Hover æ™‚åœ°æ¨™æ”¾å¤§ */
    .kt-hotspot:hover .kt-pin-icon {
        transform: scale(1.2) translateY(-5px);
        {% comment %} z-index: 20; {% endcomment %}
    }

    /* å‘¼å¸ç‡ˆå‹•ç•« (Optional) */
    .kt-pin-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: rgba(227, 29, 26, 0.4);
        border-radius: 50%;
        z-index: -1;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }

    /* B. è·äººå°å¡æ¨£å¼ (ä¾æ“š image_3ee674.png è¨­è¨ˆ) */
    .kt-artisan-card {
        position: absolute;
        bottom: 100%; /* å‡ºç¾åœ¨åœ°æ¨™ä¸Šæ–¹ */
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        width: 200px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        border: 1px solid #eee;

        /* éš±è—ç‹€æ…‹ */
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 100;
        margin-bottom: 12px; /* èˆ‡åœ°æ¨™çš„è·é›¢ */
    }

    /* Hover è§¸ç™¼é¡¯ç¤ºå°å¡ */
    .kt-hotspot:hover .kt-artisan-card {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }

    /* å°å¡ç®­é ­  é è¨­åœ¨åœ°æ¨™ä¸Šæ–¹*/
    .kt-artisan-card::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px 6px 0;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }


        /* è‹¥åœ°æ¨™ä½ç½®å¤ªé ä¸Š (Y < 45%)ï¼Œå‰‡å°‡å°å¡é¡¯ç¤ºåœ¨åœ°æ¨™ä¸‹æ–¹ */
    .kt-hotspot.kt-tooltip-bottom .kt-artisan-card {
        bottom: auto;
        top: 100%;
        margin-bottom: 0;
        margin-top: 12px;
        transform: translateX(-50%) translateY(-10px);
    }

         /* ä¸‹æ–¹é¡¯ç¤ºæ™‚çš„ç®­é ­æ–¹å‘èª¿æ•´ */
    .kt-hotspot.kt-tooltip-bottom .kt-artisan-card::after {
        bottom: auto;
        top: -6px;
        border-width: 0 6px 6px;
        border-color: transparent transparent white transparent;
    }

        /* ä¿®æ­£ä¸‹æ–¹é¡¯ç¤ºæ™‚çš„ Hover å‹•ç•« (è§£æ±ºæ¬Šé‡å•é¡Œ) */
        .kt-hotspot.kt-tooltip-bottom:hover .kt-artisan-card {
          transform: translateX(-50%) translateY(0);
        }

        /* å°å¡å…§éƒ¨æ’ç‰ˆ */
        .kt-card-inner {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
        }

        .kt-card-image img {
          width: 100%;
          max-width: 120px;
          height: 120px;
          object-fit: cover;
          border-radius: 4px;
          margin-bottom: 8px;
          border: 1px solid #ddd;
        }

        .kt-artisan-country {
          font-size: 12px;
          color: #E31D1A; /* ä½¿ç”¨å“ç‰Œç´… */
          font-weight: bold;
          margin-bottom: 4px;
        }

        .kt-artisan-name {
          margin: 0;
          font-size: 14px;
          font-weight: 700;
          color: #333;
        }

        .kt-artisan-desc {
          margin: 2px 0 8px;
          font-size: 12px;
          color: #666;
        }

        .kt-more-btn {
          display: inline-block;
          padding: 5px 12px;
          background-color: #E31D1A; /* King Tony Red */
          color: white;
          text-decoration: none;
          font-size: 10px;
          font-weight: 600;
          border-radius: 20px;
          transition: all 0.3s ease;
        }

        .kt-more-btn:hover {
          background-color: #c21916;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(227, 29, 26, 0.3);
        }


    @media (max-width: 425px) {

      /* 1. ã€é—œéµä¿®æ­£ã€‘ç´…é»è¨­å®šï¼šç§»é™¤ transform
        é€™æ˜¯ç‚ºäº†è®“è£¡é¢çš„ fixed å¡ç‰‡èƒ½å°é½Šã€Œè¢å¹•ã€è€Œä¸æ˜¯ã€Œç´…é»ã€ */
      .kt-hotspot {
        transform: none !important;

        /* å› ç‚ºç§»é™¤äº† transformï¼Œæˆ‘å€‘éœ€è¦æ‰‹å‹•ä¿®æ­£ç´…é»ä½ç½®è®“é‡å°–å°æº–åº§æ¨™ */
        /* å‡è¨­æ‚¨çš„ icon å¯¬ 20pxï¼Œé«˜ 20px */
        margin-left: -10px !important; /* å¾€å·¦ä¿®æ­£å¯¬åº¦çš„ä¸€åŠ */
        margin-top: -20px !important;  /* å¾€ä¸Šä¿®æ­£é«˜åº¦ */
      }
      .kt-artisan-card::after {
        content: '';
        visibility: hidden !important; /* æ‰‹æ©Ÿç‰ˆä¸é¡¯ç¤ºç®­é ­ï¼Œé¿å…ä½ç½®éŒ¯äº‚ */
      }

      /* 2. å¡ç‰‡å¤–æ¡†è¨­å®š (åªç®¡ä½ç½®èˆ‡æ»‘å‡ºå‹•ç•«) */
      .kt-artisan-card {
        position: fixed !important;
        left: 0 !important;
        bottom: 0 !important;
        top: auto !important;

        /* å¼·åˆ¶å¯¬åº¦ä½”æ»¿è¢å¹• */
        width: 100vw !important;
        width: 100% !important; /* é›™é‡ä¿éšª */
        margin: 0 !important;

        /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        z-index: 30; /* é™ä½å±¤ç´šï¼Œé¿å…è“‹é Header */

        /* é è¨­ç‹€æ…‹ï¼šæ”¶åœ¨åº•éƒ¨ (çœ‹ä¸åˆ°) */
        transform: translateY(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;

        /* æ‚¨çš„é™°å½±è¨­å®šï¼š0 -4px ä»£è¡¨é™°å½±å¾€ã€Œä¸Šã€è·‘ï¼Œè£½é€ å¾åº•éƒ¨æ»‘å‡ºçš„ç«‹é«”æ„Ÿ */
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15) !important;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      /* 3. ç•¶ç´…é»è¢«é»æ“Š (active) æ™‚ -> å¡ç‰‡æ»‘å‡º */
      .kt-hotspot.kt-active .kt-artisan-card {
        transform: translateY(0) !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* 4. é˜²æ­¢æ‰‹æ©Ÿç‰ˆ Hover å¹²æ“¾ (è·Ÿä¹‹å‰ä¸€æ¨£) */
      .kt-hotspot:hover .kt-artisan-card {
        transform: translateY(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;
      }

      /* 5. ç¢ºä¿ Active æ¬Šé‡æœ€é«˜ (è·Ÿä¹‹å‰ä¸€æ¨£) */
      .kt-hotspot.kt-active:hover .kt-artisan-card {
        transform: translateY(0) !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* 1. å…§éƒ¨å®¹å™¨ï¼šæ”¹æˆæ©«å‘æ’åˆ— */
    .kt-card-inner {
      display: flex !important;
      flex-direction: row !important; /* æ©«å‘æ’åˆ— */
      align-items: center !important; /* å‚ç›´ç½®ä¸­ */
      justify-content: center !important;
      gap: 15px !important; /* åœ–ç‰‡è·Ÿæ–‡å­—ä¸­é–“çš„é–“è· */
      width: 100% !important;
      height: 100% !important;
      padding: 0 20px !important; /* å·¦å³ç•™ç™½ */
      box-sizing: border-box !important; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
    }

    /* 2. å·¦é‚Šåœ–ç‰‡å€ï¼šä½”ä¸€åŠç©ºé–“ */
    .kt-card-image {
      flex: 1 !important; /* è‡ªå‹•åˆ†é…ç©ºé–“ */
      max-width: 50% !important; /* æœ€å¤§ä¸è¶…éä¸€åŠ */
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
    }

    .kt-card-image img {
      width: 100% !important;
      height: auto !important;
      max-height: 140px !important; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…åœ–ç‰‡å¤ªå¤§ */
      object-fit: contain !important; /* ä¿æŒæ¯”ä¾‹ */
      border: none !important;
      margin-bottom: 0 !important; /* ç§»é™¤åŸæœ¬åº•éƒ¨çš„ç•™ç™½ */
    }

    /* 3. å³é‚Šè³‡è¨Šå€ï¼šä½”ä¸€åŠç©ºé–“ */
    .kt-card-info {
      flex: 1 !important; /* è‡ªå‹•åˆ†é…å‰©ä¸‹çš„ç©ºé–“ */
      text-align: left !important; /* æ–‡å­—é å·¦å°é½Š (æ¯”è¼ƒå¥½çœ‹) */
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      align-items: flex-start !important; /*å…§å®¹é å·¦ */
    }

    /* å¾®èª¿æ–‡å­—å¤§å° (é¸ç”¨) */
    .kt-artisan-name {
      font-size: 16px !important;
      margin-bottom: 5px !important;
    }

    .kt-artisan-desc {
      font-size: 13px !important;
      margin-bottom: 10px !important;
      /* å¦‚æœæ–‡å­—å¤ªå¤šï¼Œé™åˆ¶é¡¯ç¤ºè¡Œæ•¸ */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    function handleGlobalClick(e) {
      // ã€é—œéµä¿®æ­£ 1ã€‘é›»è…¦ç‰ˆ (å¤§æ–¼ 768px) å®Œå…¨ä¸åŸ·è¡Œ JS
      // è®“é›»è…¦ç‰ˆå®Œå…¨ä¾è³´åŸæœ¬çš„ CSS :hover é‹ä½œï¼Œäº’ä¸å¹²æ“¾
      if (window.innerWidth > 768) return;

      const clickedHotspot = e.target.closest('.kt-hotspot');
      const clickedCard = e.target.closest('.kt-artisan-card');

      // A. å¦‚æœé»åˆ°å¡ç‰‡å…§å®¹ -> ä»€éº¼éƒ½ä¸åš (è®“ä½¿ç”¨è€…å¯ä»¥è¤‡è£½æ–‡å­—)
      if (clickedCard) return;

      // B. å¦‚æœé»åˆ°ç´…é» (Hotspot)
      if (clickedHotspot) {
        e.preventDefault(); // é˜²æ­¢äº‚è·³

        // åˆ¤æ–·ç¾åœ¨æ˜¯å¦å·²ç¶“é–‹è‘—
        const isActive = clickedHotspot.classList.contains('kt-active');

        // å…ˆé—œé–‰"æ‰€æœ‰"ç´…é» (é‡ç½®ç‹€æ…‹)
        document.querySelectorAll('.kt-hotspot').forEach((h) => {
          h.classList.remove('kt-active');
        });

        // å¦‚æœå‰›å‰›æ²’é–‹ï¼Œç¾åœ¨å°±æŠŠå®ƒæ‰“é–‹
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘æŠŠ class åŠ åœ¨ "kt-hotspot" çˆ¶å±¤ä¸Š
        if (!isActive) {
          clickedHotspot.classList.add('kt-active');
        }
        return;
      }

      // C. é»åˆ°ç©ºç™½è™• -> é—œé–‰æ‰€æœ‰
      document.querySelectorAll('.kt-hotspot').forEach((h) => {
        h.classList.remove('kt-active');
      });
    }

    // ç¶å®šé»æ“Šäº‹ä»¶
    document.removeEventListener('click', handleGlobalClick);
    document.addEventListener('click', handleGlobalClick);

    // ã€é¡å¤–ä¿éšªã€‘ç•¶è¦–çª—å¤§å°æ”¹è®Šæ™‚ï¼Œå¦‚æœæ˜¯é›»è…¦ç‰ˆï¼Œæ¸…é™¤æ‰€æœ‰æ®˜ç•™çš„ active class
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        document.querySelectorAll('.kt-hotspot').forEach((h) => {
          h.classList.remove('kt-active');
        });
      }
    });
  });
</script>
{% schema %}
{
  "name": "World Artisan Map",
  "tag": "section",
  "class": "section-world-map",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "èƒŒæ™¯é¡è‰²",
      "default": "#f4f4f4"
    }
  ],
  "blocks": [
    {
      "type": "landmark",
      "name": "ğŸ“ åœ°æ¨™ç´…é»",
      "settings": [
        {
          "type": "header",
          "content": "ä½ç½®è¨­å®š"
        },
        {
          "type": "range",
          "id": "pos_x",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "å·¦å³ä½ç½® (X)",
          "default": 50
        },
        {
          "type": "range",
          "id": "pos_y",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "ä¸Šä¸‹ä½ç½® (Y)",
          "default": 50
        },
        {
          "type": "header",
          "content": "å…§å®¹è¨­å®š"
        },
        {
          "type": "text",
          "id": "country",
          "label": "åœ‹å®¶",
          "default": "Taiwan"
        },
        {
          "type": "text",
          "id": "name",
          "label": "è·äººåç¨±",
          "default": "è·äººå§“å"
        },
        {
          "type": "text",
          "id": "description",
          "label": "æè¿°",
          "default": "å°ˆæ¥­æŠ€èƒ½"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "å¤§é ­ç…§"
        },
        {
          "type": "url",
          "id": "link",
          "label": "é€£çµ"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "World Artisan Map (é è¨­)",
      "blocks": [
        {
          "type": "landmark",
          "settings": {
            "pos_x": 50,
            "pos_y": 50,
            "name": "å°ç£è·äºº"
          }
        },
        {
          "type": "landmark",
          "settings": {
            "pos_x": 20,
            "pos_y": 40,
            "name": "åœ¨åœ°è·äºº"
          }
        }
      ]
    }
  ]
}
{% endschema %}
